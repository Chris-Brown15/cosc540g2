<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SwitchUp - Market Exchange</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar" style="background: linear-gradient(135deg, #34e89e 0%, #0f3443 100%); color: white;">
      <div class="logo" style="font-family: 'Playfair Display', serif; color: white; font-weight: bold; font-size: 28px;">SwitchUp</div>
      <div class="nav-links">
        <a href="#" class="active" style="font-family: 'Playfair Display', serif; color: white; font-weight: 500;">Explore</a>
        <a href="#past-trades" style="font-family: 'Playfair Display', serif; color: white; font-weight: 500;">Past Trades</a>
        <a href="#my-inventory" style="font-family: 'Playfair Display', serif; color: white; font-weight: 500;">My Inventory</a>
      </div>
      <div class="nav-icons">
        <button class="icon-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
        </button>
        <button class="icon-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
        </button>
        <button id="profileButton" class="icon-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </button>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        <div class="hero-section">
            <h1>Explore The Market</h1>
            <p>Search for items you know you want to tradeâ€”or discover ones you didn't realize you needed.</p>
        </div>

        <div class="combo-box">
            <div class="input-wrapper">
              <input
                type="text"
                id="combo-input"
                class="search-bar"
                placeholder="What are you looking to trade?"
                autocomplete="off"
              />
            </div>
            <ul class="dropdown" id="dropdown"></ul>
          </div>

        <div class="trending-tags">
            <span class="tag">Trending</span>
            <span class="tag">Computers</span>
            <span class="tag">Coffee Filters</span>
        </div>

        <div class="categories">
            <a href="#" class="active">All</a>
            <a href="#">Home & Kitchen</a>
            <a href="#">Automotive</a>
            <a href="#">Electronics</a>
        </div>

        <div class="items-grid" id="productsContainer">
            <!-- Item cards will be dynamically populated here -->
        </div>
        
    <!-- Chat User List -->
    <div id="chatUsersList" class="chat-users-list hidden">
      <div class="chat-users-header">Conversations</div>
      <div id="chatUsersContainer">
        <!-- User items will be dynamically loaded here -->
      </div>
    </div>

    <!-- Chat Window -->
    <div id="chatContainer" class="chat-container hidden">
      <div class="chat-header">
        <div class="chat-header-user">
          <img id="chatUserAvatar" src="/static/images/default-avatar.png" alt="User avatar">
          <div class="user-info">
            <div id="chatUserName" class="user-name">User Name</div>
            <div id="chatUserStatus" class="user-status">Active now</div>
          </div>
        </div>
        <div class="chat-header-actions">
          <button id="minimizeChatBtn">â€”</button>
          <button id="closeChatBtn">Ã—</button>
        </div>
      </div>
      
      <div id="chatMessages" class="chat-messages">
        <!-- Messages will be dynamically loaded here -->
      </div>
      
      <div class="chat-input-container">
        <input type="text" id="messageInput" class="chat-input" placeholder="Type a message...">
        <button id="sendMessageBtn" class="send-button">
          <span style="font-size: 24px;">âž¤</span>
        </button>
      </div>
    </div>

    <!-- Floating Button Area -->
    <div class="floating-buttons">
      <button id="openChatButton" class="chat-button">
        ðŸ’¬ Chat
        <span id="chatNotificationBadge" class="badge hidden">1</span>
      </button>
      <button class="upload-button">Upload New Item</button>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAuthModal()">&times;</span>

            <div class="auth-header">
                <h2 id="auth-title">Login Form</h2>
            </div>

            <div class="tab">
                <button id="loginTab" class="active" onclick="switchTab('login')">Login</button>
                <button id="signupTab" onclick="switchTab('signup')">Signup</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="email" id="login-email" placeholder="Email Address" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" placeholder="Password" required>
                </div>
                <div class="forgot-password">
                    <a href="#">Forgot password?</a>
                </div>
                <button type="submit" class="submit-btn">Login</button>

                <button type="button" class="google-btn">
                    <img src="https://images.icon-icons.com/729/PNG/512/google_icon-icons.com_62736.png" alt="Google">
                    Sign in with Google
                </button>

                <div class="auth-footer">
                    Not a member? <a onclick="switchTab('signup')">Signup now</a>
                </div>
            </form>

            <!-- Signup Form -->
            <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="signup-firstname" placeholder="First Name" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="signup-lastname" placeholder="Last Name" required>
                    </div>
                </div>
                <div class="form-group">
                    <input type="email" id="signup-email" placeholder="Email Address" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signup-password" placeholder="Password" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signup-confirm-password" placeholder="Confirm password" required>
                </div>
                <button type="submit" class="submit-btn">Signup</button>

                <button type="button" class="google-btn">
                    <img src="https://images.icon-icons.com/729/PNG/512/google_icon-icons.com_62736.png" alt="Google">
                    Sign up with Google
                </button>

                <div class="auth-footer">
                    Already a member? <a onclick="switchTab('login')">Login</a>
                </div>
            </form>
        </div>
    </div>
      
    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/listing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/search.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        async function createConversation(tradeId, participantIds) {
          try {
            const response = await fetch('/api/conversations', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                trade_id: tradeId,
                participants: participantIds
              }),
            });
      
            const result = await response.json();
            if (response.ok) {
              console.log('Conversation created!', result);
              document.getElementById('createConversationResult').innerText = `Conversation Created! ID: ${result.conversation_id}`;
      
              // After creating, automatically fetch and show the conversation
              fetchConversation(result.conversation_id);
            } else {
              console.error('Error creating conversation:', result.error);
            }
          } catch (error) {
            console.error('Failed to create conversation:', error);
          }
        }
      
        async function fetchConversation(conversationId) {
          try {
            const response = await fetch(`/api/conversations/${conversationId}`);
            const conversation = await response.json();
            if (response.ok) {
              console.log('Fetched conversation:', conversation);
      
              // Pretty print the fetched conversation
              const formatted = JSON.stringify(conversation, null, 2);
              document.getElementById('createConversationResult').innerText += `\nFetched Conversation:\n${formatted}`;
            } else {
              console.error('Error fetching conversation:', conversation.error);
            }
          } catch (error) {
            console.error('Failed to fetch conversation:', error);
          }
        }
      
        document.getElementById('createConversationForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const tradeId = document.getElementById('tradeIdInput').value;
          const participant1 = document.getElementById('participant1Input').value;
          const participant2 = document.getElementById('participant2Input').value;
          createConversation(tradeId, [participant1, participant2]);
        });
      </script>

      <script>
        async function chatWithUser(username, messageText) {
          try {
            const lookupResponse = await fetch(`/api/users/lookup?username=${encodeURIComponent(username)}`);
            const lookupResult = await lookupResponse.json();
        
            if (!lookupResponse.ok) {
              document.getElementById('chatBoxResult').innerText = `User not found: ${username}`;
              return;
            }
        
            const recipientId = lookupResult.user_id;
            const yourUserId = currentUser.id; // use your logged in user ID
        
            // Always create a new conversation for now (later you could "check" first)
            const convoResponse = await fetch('/api/conversations', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                trade_id: yourUserId, // Placeholder
                participants: [yourUserId, recipientId],
              }),
            });
        
            const convoResult = await convoResponse.json();
            if (!convoResponse.ok) {
              document.getElementById('chatBoxResult').innerText = `Error creating conversation: ${convoResult.error}`;
              return;
            }
        
            const conversationId = convoResult.conversation_id;
        
            // Send message
            const sendMessageResponse = await fetch(`/api/conversations/${conversationId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sender_id: yourUserId,
                text: messageText,
                timestamp: new Date().toISOString(),
                images: [],
              }),
            });
        
            if (!sendMessageResponse.ok) {
              const errorData = await sendMessageResponse.json();
              document.getElementById('chatBoxResult').innerText = `Failed to send message: ${errorData.error}`;
              return;
            }
        
            // Message sent â€” Now Fetch the whole conversation
            const getConvoResponse = await fetch(`/api/conversations/${conversationId}`);
            const convoData = await getConvoResponse.json();
        
            if (!getConvoResponse.ok) {
              document.getElementById('chatBoxResult').innerText = `Error fetching conversation!`;
              return;
            }
        
            // Build HTML of all messages
            const messagesHtml = convoData.messages.map(msg => {
              const sender = (msg.sender_id === yourUserId) ? "You" : "Them";
              return `<div><strong>${sender}:</strong> ${msg.text}</div>`;
            }).join("");
        
            document.getElementById('chatBoxResult').innerHTML = `
              <h4>Conversation with ${username}:</h4>
              ${messagesHtml}
            `;
        
            // Clear the form
            document.getElementById('chatBoxForm').reset();
        
          } catch (error) {
            console.error('Chat error:', error);
            document.getElementById('chatBoxResult').innerText = `Error: ${error.message}`;
          }
        }
        
        document.getElementById('chatBoxForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const username = document.getElementById('recipientUsername').value.trim();
          const message = document.getElementById('chatMessage').value.trim();
          chatWithUser(username, message);
        });
        </script>  


        <script>
          // Chat variables
          let currentChatUserId = null;
          let currentChatUsername = null;
          let activeConversationId = null;
          let chatVisible = false;
          
          // DOM Elements
          const chatUsersList = document.getElementById('chatUsersList');
          const chatContainer = document.getElementById('chatContainer');
          const chatUsersContainer = document.getElementById('chatUsersContainer');
          const chatUserName = document.getElementById('chatUserName');
          const chatUserStatus = document.getElementById('chatUserStatus');
          const chatUserAvatar = document.getElementById('chatUserAvatar');
          const chatMessages = document.getElementById('chatMessages');
          const messageInput = document.getElementById('messageInput');
          const sendMessageBtn = document.getElementById('sendMessageBtn');
          const openChatButton = document.getElementById('openChatButton');
          const closeChatBtn = document.getElementById('closeChatBtn');
          const minimizeChatBtn = document.getElementById('minimizeChatBtn');
          const chatNotificationBadge = document.getElementById('chatNotificationBadge');
          
          // Event Listeners
          openChatButton.addEventListener('click', toggleChatUsersList);
          closeChatBtn.addEventListener('click', closeChat);
          minimizeChatBtn.addEventListener('click', minimizeChat);
          sendMessageBtn.addEventListener('click', sendMessage);
          messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              sendMessage();
            }
          });
          
          // Functions
          function toggleChatUsersList() {
            // Toggle visibility
            if (chatUsersList.classList.contains('hidden')) {
              chatUsersList.classList.remove('hidden');
              loadChatUsers();
              hideNewMessageBadge();
              chatUsersList.style.bottom = "140px";
            } else {
              chatUsersList.classList.add('hidden');
            }
            
            // Always hide the chat container when showing the user list
            if (!chatContainer.classList.contains('hidden')) {
              chatContainer.classList.add('hidden');
            }
          }
          
          function openChatWithUser(userId, username, avatarSrc = null) {
            // Set the current chat user
            currentChatUserId = userId;
            currentChatUsername = username;
            
            // Update the chat header
            chatUserName.textContent = username;
            chatUserStatus.textContent = 'Active now'; // Placeholder - could be dynamic
            
            // Set avatar
            if (avatarSrc) {
              chatUserAvatar.src = avatarSrc;
            } else {
              // Create default avatar with user initials
              chatUserAvatar.src = `/static/images/default-avatar.png`;
            }
            
            // Clear previous messages
            chatMessages.innerHTML = '';
            
            // Show the chat container
            chatContainer.classList.remove('hidden');
            
            // Hide the user list
            chatUsersList.classList.add('hidden');
            
            // Set chat as visible
            chatVisible = true;
            
            // Load conversation history if available
            loadConversation(userId);
          }
          
          function closeChat() {
            chatContainer.classList.add('hidden');
            chatUsersList.classList.add('hidden');
            chatVisible = false;
          }
          
          function minimizeChat() {
            chatContainer.classList.add('hidden');
            chatVisible = false;
          }
          
          function showNewMessageBadge(count = 1) {
            chatNotificationBadge.textContent = count;
            chatNotificationBadge.classList.remove('hidden');
          }
          
          function hideNewMessageBadge() {
            chatNotificationBadge.classList.add('hidden');
          }
          
          async function loadChatUsers() {
            if (!currentUser) {
              chatUsersContainer.innerHTML = '<div style="padding: 15px; text-align: center;">Please log in to chat</div>';
              // Show the user list even when not logged in
              chatUsersList.classList.remove('hidden');
              return;
            }
            
            try {
              const response = await fetch('/api/users/all');
              if (!response.ok) {
                throw new Error('Failed to load users');
              }
              
              const users = await response.json();
              chatUsersContainer.innerHTML = '';
              
              if (users.length <= 1) {
                chatUsersContainer.innerHTML = '<div style="padding: 15px; text-align: center;">No other users available to chat with</div>';
                return;
              }
              
              users.forEach(user => {
                // Skip the current user
                if (currentUser && user._id === currentUser.id) return;
                
                const userElement = document.createElement('div');
                userElement.className = 'chat-user-item';
                userElement.dataset.userId = user._id;
                
                // Create initials for avatar
                const initials = user.username.substring(0, 2).toUpperCase();
                
                userElement.innerHTML = `
                  <div class="chat-user-avatar">${initials}</div>
                  <div class="chat-user-info">
                    <div class="chat-user-name">${user.username}</div>
                    <div class="chat-user-status">
                      <span class="online-indicator"></span>
                      Active now
                    </div>
                  </div>
                `;
                
                userElement.addEventListener('click', () => {
                  if (!currentUser) {
                    showAuthModal();
                    chatUsersList.classList.add('hidden');
                  } else {
                    openChatWithUser(user._id, user.username);
                  }
                });
                
                chatUsersContainer.appendChild(userElement);
              });
            } catch (error) {
              console.error('Error loading chat users:', error);
              chatUsersContainer.innerHTML = '<div style="padding: 15px; text-align: center;">Failed to load users</div>';
            }
          }
          
          async function loadConversation(userId) {
            if (!currentUser) return;
            
            try {
              // Check if a conversation already exists
              const checkResponse = await fetch(`/api/conversations/check?user1=${currentUser.id}&user2=${userId}`);
              const checkData = await checkResponse.json();
              
              if (checkData.exists) {
                // Conversation exists, load it
                activeConversationId = checkData.conversation_id;
                const convoResponse = await fetch(`/api/conversations/${activeConversationId}`);
                const conversation = await convoResponse.json();
                
                // Display messages
                displayMessages(conversation.messages);
              } else {
                // No existing conversation, create a new one when the first message is sent
                activeConversationId = null;
                chatMessages.innerHTML = '<div class="text-center p-3">No messages yet. Say hello!</div>';
              }
            } catch (error) {
              console.error('Error loading conversation:', error);
              chatMessages.innerHTML = '<div class="text-center p-3">Failed to load messages</div>';
            }
          }
          
          function displayMessages(messages) {
            chatMessages.innerHTML = '';
            
            if (!messages || messages.length === 0) {
              chatMessages.innerHTML = '<div class="text-center p-3">No messages yet. Say hello!</div>';
              return;
            }
            
            messages.forEach(message => {
              const isCurrentUser = message.sender_id === currentUser.id;
              const messageElement = document.createElement('div');
              messageElement.className = `message ${isCurrentUser ? 'message-sent' : 'message-received'}`;
              
              // Format timestamp
              const timestamp = new Date(message.timestamp);
              const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              
              messageElement.innerHTML = `
                ${message.text}
                <div class="message-time">${timeString}</div>
              `;
              
              chatMessages.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
          
          async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatUserId || !currentUser) return;
            
            try {
              if (!activeConversationId) {
                // Create a new conversation
                const createResponse = await fetch('/api/conversations', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    trade_id: currentUser.id, // Using current user ID as placeholder
                    participants: [currentUser.id, currentChatUserId]
                  })
                });
                
                if (!createResponse.ok) {
                  throw new Error('Failed to create conversation');
                }
                
                const createResult = await createResponse.json();
                activeConversationId = createResult.conversation_id;
              }
              
              // Send the message
              const sendResponse = await fetch(`/api/conversations/${activeConversationId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  sender_id: currentUser.id,
                  text: text,
                  timestamp: new Date().toISOString(),
                  images: []
                })
              });
              
              if (!sendResponse.ok) {
                throw new Error('Failed to send message');
              }
              
              // Add message to the UI
              const messageElement = document.createElement('div');
              messageElement.className = 'message message-sent';
              
              const timestamp = new Date();
              const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              
              messageElement.innerHTML = `
                ${text}
                <div class="message-time">${timeString}</div>
              `;
              
              chatMessages.appendChild(messageElement);
              
              // Clear input
              messageInput.value = '';
              
              // Scroll to bottom
              chatMessages.scrollTop = chatMessages.scrollHeight;
              
              // Reload conversation to get any potential new messages
              loadConversation(currentChatUserId);
              
            } catch (error) {
              console.error('Error sending message:', error);
              alert('Failed to send message. Please try again.');
            }
          }
          
          // Initialize chat if user is logged in
          document.addEventListener('DOMContentLoaded', () => {
            if (currentUser) {
              // Show notification badge to indicate new messages (for demo)
              setTimeout(() => {
                showNewMessageBadge(2);
              }, 3000);
            }
          });
        </script>

      <script>
        // --- Badge control functions for chat icon ---
        function showNewMessageBadge(count = 1) {
          const badge = document.getElementById('chatNotificationBadge');
          badge.innerText = count;
          badge.classList.remove('hidden');
        }

        function hideNewMessageBadge() {
          const badge = document.getElementById('chatNotificationBadge');
          badge.classList.add('hidden');
        }
      </script>
  
</body>

</html>